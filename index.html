<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="page-title">Carregando...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS VARIÁVEIS DINÂMICAS */
        :root {
            --primary: #4b0082; /* Será alterado pelo JS */
            --primary-dark: #2e0052;
            --accent: #00d26a;
            --bg: #f8f9fa;
            --white: #ffffff;
            --text: #333;
        }

        /* [MESMOS ESTILOS ANTERIORES - MANTIDOS PARA ECONOMIZAR ESPAÇO] */
        /* ... (Copie os estilos do código anterior aqui) ... */
        
        /* ADICIONE APENAS ESTA CORREÇÃO NO CSS */
        .section-title::before { background: var(--primary) !important; }
        .btn-action { color: var(--primary); }
        header { background: var(--primary); }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="loading-text">Buscando informações da loja...</div>
    </div>

    <!-- MODAL E TOAST (MANTIDOS) -->
    <div id="toast-box">Item adicionado!</div>
    <div id="custom-modal" class="modal-overlay"><div class="modal-box">...</div></div>

    <header>
        <div class="profile-container">
            <img src="" id="loja-logo" class="profile-logo" style="display:none">
            <div class="profile-info">
                <div class="profile-handle">
                    <i class="fab fa-instagram insta-icon"></i> <span id="loja-insta">@carregando</span>
                </div>
                <div class="status-badge">
                    <span class="status-dot"></span> <span id="txt-status">Aberto agora</span>
                </div>
            </div>
        </div>
    </header>

    <div id="app-container">
        <div class="slider-wrapper" id="slider">
            
            <!-- TELA 0: CARDÁPIO DINÂMICO -->
            <div class="step-screen" id="step-1">
                <div id="container-categorias">
                    <!-- Categorias e produtos entram aqui via JS -->
                </div>
            </div>

            <!-- AS OUTRAS TELAS (MONTAGEM, CARRINHO, SUCESSO) CONTINUAM IGUAIS -->
            <!-- ... -->
        </div>
    </div>

    <!-- BOTÕES FLUTUANTES E FOOTER (MANTIDOS) -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, child, push, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCnTKk4-WSvSpoy0onqWBTDLqDfY9oaEdE",
            authDomain: "drxagencia-6ce0a.firebaseapp.com",
            databaseURL: "https://drxagencia-6ce0a-default-rtdb.firebaseio.com",
            projectId: "drxagencia-6ce0a",
            storageBucket: "drxagencia-6ce0a.firebasestorage.app",
            messagingSenderId: "251757919420",
            appId: "1:251757919420:web:26a49c29d0bab8cafca4b9"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getDatabase(firebaseApp);
        const dbRef = ref(db);

        class AppController {
            constructor() {
                // 1. PEGA O ID DA EMPRESA PELA URL (?id=universo_acai)
                const params = new URLSearchParams(window.location.search);
                this.empresaId = params.get('id') || "universo_acai"; 
                
                this.carrinho = JSON.parse(localStorage.getItem(`cart_${this.empresaId}`)) || [];
                this.telaAtual = 0;
                this.produtoEmMontagem = null;
                this.estoque = { sabores: [], recheios: [], adicionais: [], categorias: [] };
            }

            async init() {
                try {
                    await this.carregarConfiguracoes();
                    await this.buscarCardapio();
                    this.renderizarCardapio();
                    this.atualizarBotaoFlutuante();
                    
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
                } catch (e) {
                    console.error(e);
                    document.getElementById('loading-text').innerText = "Erro ao carregar loja.";
                }
            }

            async carregarConfiguracoes() {
                const snap = await get(child(dbRef, `empresas/${this.empresaId}/config`));
                if (snap.exists()) {
                    const config = snap.val();
                    // Aplica Nome e Título
                    document.title = config.nome;
                    document.getElementById('loja-insta').innerText = config.instagram;
                    
                    // Aplica Logo
                    const logo = document.getElementById('loja-logo');
                    logo.src = config.logo;
                    logo.style.display = 'block';

                    // APLICA COR DINÂMICA
                    if (config.cor_primaria) {
                        document.documentElement.style.setProperty('--primary', config.cor_primaria);
                    }
                }
            }

            async buscarCardapio() {
                const path = `empresas/${this.empresaId}/cardapio`;
                const snap = await get(child(dbRef, path));
                if (snap.exists()) {
                    const data = snap.val();
                    this.estoque.categorias = data.categorias || [];
                    this.estoque.sabores = data.sabores ? Object.values(data.sabores) : [];
                    this.estoque.recheios = data.recheios ? Object.values(data.recheios) : [];
                    this.estoque.adicionais = data.adicionais ? Object.values(data.adicionais) : [];
                }
            }

            renderizarCardapio() {
                const container = document.getElementById('container-categorias');
                container.innerHTML = '';

                this.estoque.categorias.forEach(cat => {
                    const section = document.createElement('div');
                    section.innerHTML = `<div class="section-title">${cat.titulo}</div>`;
                    
                    const grid = document.createElement('div');
                    grid.className = 'grid-produtos';

                    cat.produtos.forEach(p => {
                        grid.innerHTML += `
                            <div class="card-produto" onclick="app.abrirMontagem('${p.id}', '${p.nome}', ${p.preco})">
                                <img src="${p.img}" onerror="this.src='https://placehold.co/200x200?text=Produto'">
                                <h3>${p.nome}</h3>
                                <div class="price">R$ ${p.preco.toFixed(2)}</div>
                            </div>
                        `;
                    });
                    
                    section.appendChild(grid);
                    container.appendChild(section);
                });
            }

            // ... (Restante das funções de montagem, carrinho e enviarPedido permanecem as mesmas)
            // Lembre-se de usar this.empresaId em todas as referências ao banco!
        }

        // Inicialização
        const app = new AppController();
        window.app = app;
        app.init();
    </script>
</body>
</html>